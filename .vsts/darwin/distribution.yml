steps:
  - template: ./darwin-dependencies.yml
  - script: |
      set -e
      . "$(Agent.WorkFolder)/.venv/batchexplorer/bin/activate"
      npm run build:prod
    displayName: Build packages

  - script: |
      npm run build-python
      npm run package darwin-app
      cd ./release/mac
      zip -y -r ../BatchExplorer-mac.zip ./BatchExplorer.app
      cd ../..
      rm -rf ./release/mac/*.app
      mkdir ./release/keep
      cp ./release/*.zip ./release/keep/before-code-sign.zip
    workingDirectory: desktop
    displayName: Build .app

  - template: ./sign.yml
  - script: |
      set -e
      . "$(Agent.WorkFolder)/.venv/batchexplorer/bin/activate"
      unzip ./release/BatchExplorer*.zip -d ./release/mac
      ls ./release/mac
      rm -f ./release/mac/*.pkg
      # rm -rf ./release/*.zip
      mv ./release/*.zip ./release/code-sign-results.zip
      npm run package darwin-dmg
      rm -rf ./release/mac/*
    workingDirectory: desktop
    displayName: Build dmg

  - script: npm run package darwin-manifest
    workingDirectory: desktop
    displayName: Create manifest
  - template: ../common/generate-sbom.yml
  - template: ../common/publish-artifacts.yml
    parameters:
      folder: darwin
