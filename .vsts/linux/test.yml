steps:
  - template: ./linux-dependencies.yml

  - script: npm run lint
    displayName: Lint

  - script: npm run build:clean
    displayName: Build packages

  - script: npm run test-models
    workingDirectory: desktop
    displayName: Test models against swagger

  - script: |
      export DISPLAY=:99
      xvfb-run --server-args '-screen 0 1024x768x24' npm run test:all
    displayName: Run tests

  - task: PublishTestResults@2
    inputs:
      testRunner: 'JUnit'
      testResultsFiles: '**/TEST*-*.xml'
      searchFolder: $(System.DefaultWorkingDirectory)/build

  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: cobertura
      summaryFileLocation: $(System.DefaultWorkingDirectory)/build/*/coverage/cobertura.xml
      reportDirectory: $(System.DefaultWorkingDirectory)/build/*/coverage/html
  - script: codecov -t $(codecov.uploadToken)
    displayName: Upload code coverage to codecov

  - task: PublishBuildArtifacts@1
    displayName: publish sarif results
    inputs:
      # The exact name "CodeAnalysisLogs" is required for the Sarif Results Viewer Extension for Azure Pipelines
      # to find the .sarif files our accessibility test produces.
      artifactName: "CodeAnalysisLogs"
      # "test-results" is not a required convention; it just happens to be where our tests write .sarif files to.
      pathtoPublish: "$(System.DefaultWorkingDirectory)/build/test-results"
    condition: succeededOrFailed()
