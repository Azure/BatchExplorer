steps:
  - template: ../common/set-dist-vars.yml
  - template: ./credscan.yml
  - template: ./win-dependencies.yml
  - template: ../common/download-i18n-artifacts.yml

  - powershell: |
      $(System.DefaultWorkingDirectory)/Localize/copy-translations.ps1 -artifactsPath "$(Agent.BuildDirectory)/drop/loc"
    displayName: 'Run copy-translations.ps1 with artifacts path (Windows)'

  - powershell: |
      $(System.DefaultWorkingDirectory)/Localize/merge-translations.ps1 -repositoryRoot "$(System.DefaultWorkingDirectory)"
    displayName: 'Run merge-translations.ps1 with artifacts path (Windows)'

  - powershell: |
      $version = npm run -s ts scripts/package/get-version
      Write-Host "Updating build number to $version"
      Write-Host "##vso[build.updatebuildnumber]$version"
    workingDirectory: desktop
    displayName: Update build version for packaging

  - powershell: |
      . .vsts/win/exec.ps1
      $ErrorActionPreference = "Stop"
      $(Agent.WorkFolder)\.venv\batchexplorer\Scripts\Activate.ps1
      exec { npm run build:prod }
    displayName: Build all packages

  - powershell: |
      . ../.vsts/win/exec.ps1
      $ErrorActionPreference = "Stop"
      $(Agent.WorkFolder)\.venv\batchexplorer\Scripts\Activate.ps1
      exec { npm run build-python }
      exec { npm run package win-exe }
    workingDirectory: desktop
    displayName: Build .exe

  - template: ./security-analysis.yml

  - template: ./sign.yml
    parameters:
      name: "Sign executable and dll"
      pattern: |
        **/*.exe
        **/*.dll
        !**/python36.dll

  - powershell: npm run package win-installer
    workingDirectory: desktop
    displayName: Build installer

  - template: ./sign.yml
    parameters:
      name: "Sign installer"
      pattern: |
        **/BatchExplorer*Setup*.exe

  - powershell: npm run package win-manifest
    workingDirectory: desktop
    displayName: Create manifest
  - template: ../common/generate-sbom.yml
  - template: ../common/publish-artifacts.yml
    parameters:
      folder: windows
