# BatchManagement REST client library

This directory contains the Batch Management plane RLC (Rest Level Client) library intended for use within the Shared Library for Batch Explorer and the Portal. This package will act as a data and service communication layer for invoking REST API calls for the Batch Management plane and return modeless results. Currently, there is a lot of code duplication between the Portal and Batch Explorer, so this package will act as an environment agnostic library to be used in both the Portal and Batch Explorer to eliminate custom code duplication between the two environments. In this context, a RLC (Rest Level Client) is an Azure specific SDK flavor that emphasizes seamless developer experience by acting as a layer above raw HTTP calls. One of the major benefits of this SDK type is that they provide a compact, browser friendly bundle size footprint by relying on an abstract REST client and contains Batch specific Typescript type definitions as oppose to exportable classes. More information about RLCs can be found [here](https://devblogs.microsoft.com/azure-sdk/azure-rest-libraries-for-javascript/).

## Development Prerequisites

Before developing against this library, make sure you run the following commands from the root directory of the repo to build the shared libraries```npm install && npm run dev-setup && npm run build:clean```.

## Package Layout

This SDK library is built through autogenerated code by invoking autorest with our Batch Management swagger configuration file hosted at <https://github.com/Azure/azure-rest-api-specs/tree/main/specification/batch/resource-manager/Microsoft.Batch/stable>.

- `swagger` - This subdirectory contains the swagger configuration file containing documented autorest command options to make the code regeneration process easier to invoke in case there is a need to refresh the rest api input file or other changes. The associated README.md configuration file contains autorest command options such as: package name and version, swagger input file, source code folder path, client authentication customization, etc.

To invoke autorest and regenerate the code, run the following from the same directory as this README:

```shell
autorest --typescript swagger/README.md
```

This will parse the command options from the README and regenerate the SDK code within the src/generated folder.

- `src` - This subdirectory contains all the source code, both generated and manually written.
    - `src/generated/` - This holds the swagger autogenerated code such as obtaining the client and Batch specific modeless interfaces. These files should generally not be modified manually.
    - `src/http/` - This contains manually written HTTP related code such as parsing the custom http client from the Shared Library common and generated SDK HTTP Client interface.

## Building and Running Tests

To build the Batch Management plane client, run the following from the same directory as this README.md:

```shell
npm install && npm run build:clean
```

## Unit Tests

Invoking `npm test` will directly invoke Jest and run all the test suites as exists under src/\_\__tests\_\_. If you would like to test a particular test file, you can pass the test file relative path to the command i.e. `npm test -- .\src\__tests__\batch-management-client.spec.ts`.

The tests defined in the `batch-management-client.spec.ts` file tests a live BatchManagementClient instance that makes direct REST API calls to the management plane. In order to run that particular test file, you will need an active Batch account along with an Azure Active Directory Service Principal with RBAC access configured for your Batch Account. More information on authenticating a service principal for your Batch account can be found at <https://learn.microsoft.com/en-us/azure/batch/batch-aad-auth#use-a-service-principal>. Once you have a Batch account with a service principal assigned RBAC access, configure the following environment variables:
    - __MABOM_BatchAccountSubscriptionId__
    - __MABOM_BatchAccountResourceGroupName__
    - __MABOM_BatchAccountName__
    - __AZURE_TENANT_ID__
    - __AZURE_CLIENT_ID__
    - __AZURE_CLIENT_SECRET__
